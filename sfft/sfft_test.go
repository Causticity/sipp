// Copyright Raul Vera 2020

// Tests for package sfft.

package sfft

import (
	"reflect"
	"testing"

	"github.com/davidkleiven/gosfft/sfft"
)

import (
	. "github.com/Causticity/sipp/sipptesting"
)

var cosxcosyTinyFft = []complex128{
	(-6 + 0i), (0 + 0i), (1.618033988749895 + 6.432881625776282i), (0 + 0i),
	(2.618033988749895 - 0.44902797657958615i), (0 + 0i),
	(-0.6180339887498949 - 6.6043950509300915i), (0 + 0i),
	(0.3819660112501051 + 4.9797965697655595i), (0 + 0i), (-2 + 0i), (0 + 0i),
	(0.3819660112501051 - 4.9797965697655595i), (0 + 0i),
	(-0.6180339887498949 + 6.6043950509300915i), (0 + 0i),
	(2.618033988749895 + 0.44902797657958615i), (0 + 0i),
	(1.618033988749895 - 6.432881625776282i), (0 + 0i), (0 + 0i),
	(5.73266050294879 + 3.9655787577012136i), (0 + 0i),
	(-8.577627128280994 - 2.570022922409268i), (0 + 0i),
	(4.060497472914843 - 10.79245196208926i), (0 + 0i),
	(-5.591266066100834 - 0.012486406574207187i), (0 + 0i),
	(7.495886511675053 - 5.557536515835409i), (0 + 0i),
	(2.2360679775010794 - 6.881909602356245i), (0 + 0i),
	(5.1649489327391525 - 2.666045055090495i), (0 + 0i),
	(-7.998847468754418 - 6.341559150781226i), (0 + 0i),
	(-1.6660450550905201 + 6.229503485085139i), (0 + 0i),
	(8.764835310677139 + 1.9238859367485226i),
	(3.8541019662496847 - 8.057480106940814i), (0 + 0i),
	(2.2360679774997894 + 1.6245984811645324i), (0 + 0i),
	(-3.3819660112501047 + 4.2532540417602i), (0 + 0i),
	(3.6180339887498945 - 1.1755705045849465i), (0 + 0i),
	(3.5278640450004204 + 12.310734148701014i), (0 + 0i),
	(1.381966011250105 - 3.3551980886010284i), (0 + 0i),
	(-4.23606797749979 + 9.23305061152576i), (0 + 0i),
	(-1.3819660112501047 - 1.9021130325903075i), (0 + 0i),
	(-2.854101966249685 + 3.5267115137548384i), (0 + 0i),
	(-2.7639320225002098 + 7.053423027509677i), (0 + 0i), (0 + 0i),
	(-5.094869601436027 - 7.363627415743853i), (0 + 0i),
	(5.0008919469614685 + 3.480534028619176i), (0 + 0i),
	(10.178475052770501 - 0.4839100580909341i), (0 + 0i),
	(-10.128599151701406 + 4.7159209561596i), (0 + 0i),
	(2.719978035591339 - 5.647706459585381i), (0 + 0i),
	(-5.411638482084527 - 8.027807636106559i), (0 + 0i),
	(-2.2360679774997854 + 1.6245984811645338i), (0 + 0i),
	(2.6660450550905175 - 12.698622074110702i), (0 + 0i),
	(-4.458053684715686 + 11.232848261033226i), (0 + 0i),
	(-1.7734010631007484 + 6.411638482085072i),
	(0.3819660112501051 + 2.628655560595668i),
	(0 + 0i), (3.8541019662496847 + 1.9021130325903068i), (0 + 0i),
	(-0.34752415750147203 - 1.069569378312981i), (0 + 0i),
	(-9.23606797749979 + 5.257311121191336i), (0 + 0i),
	(-2.381966011250103 - 0.27751455142577486i), (0 + 0i),
	(-4.562305898749054 - 0.2775145514257753i), (0 + 0i),
	(-9.090169943749473 + 1.9021130325903068i), (0 + 0i),
	(0.23606797749978892 - 2.179627584016083i), (0 + 0i),
	(1.8885438199983178 - 9.06153718637195i), (0 + 0i),
	(-8.381966011250105 + 1.1755705045849463i), (0 + 0i), (0 + 0i),
	(-12.755062467594591 - 3.277514551425334i), (0 + 0i),
	(-8.518994490094439 + 5.5912660661006175i), (0 + 0i), (-2 - 8i), (0 + 0i),
	(2.3386546025957067 - 1.1191301111012617i), (0 + 0i),
	(-1.8974133749038629 - 2.7224854485746164i), (0 + 0i),
	(12.620938536936137 + 5.0948696014349935i), (0 + 0i),
	(3.795469328063323 + 5.057480106940792i), (0 + 0i), (10 + 0i), (0 + 0i),
	(12.857006514435408 - 11.057480106941002i), (0 + 0i),
	(3.559401350563398 - 9.567005556434701i),
	(-2.8541019662496847 - 0.2775145514257753i), (0 + 0i),
	(-3.6180339887498945 + 1.1755705045849458i), (0 + 0i),
	(12.47213595499958 + 2.906170112021443i), (0 + 0i),
	(-2.2360679774997902 + 6.881909602355869i), (0 + 0i),
	(3.854101966249684 + 5.706339097770922i), (0 + 0i),
	(3.618033988749895 + 7.330937578935453i), (0 + 0i),
	(-5.618033988749894 + 2.628655560595668i), (0 + 0i),
	(-7.23606797749979 + 11.412678195541844i), (0 + 0i),
	(0.2360679774997898 + 2.1796275840160826i), (0 + 0i),
	(1.3819660112501047 - 1.9021130325903073i), (0 + 0i), (0 + 0i),
	(4.516089941908957 - 3.2965654504144895i), (0 + 0i),
	(8.892531174201782 + 8.520147021340158i), (0 + 0i),
	(-1.2342031427713414 - 2.280021964409276i), (0 + 0i),
	(7.031976668605138 - 6.276082318435137i), (0 + 0i),
	(9.567005556436925 - 8.816712471755087i), (0 + 0i),
	(10.537333085600949 + 4.060497472915017i), (0 + 0i),
	(0.2053374728119497 + 8.11467589646806i), (0 + 0i),
	(-1.1381810100900969 + 2.5182821866117537i), (0 + 0i),
	(-2.2360679774996584 - 1.6245984811645746i), (0 + 0i),
	(-3.0604974729149275 + 5.736011568605747i),
	(2.618033988749895 + 4.2532540417602i), (0 + 0i),
	(-4.76393202250021 + 8.5065080835204i), (0 + 0i),
	(2.0901699437494745 + 1.1755705045849454i), (0 + 0i),
	(-10.618033988749895 - 1.9021130325903077i), (0 + 0i),
	(-31.65247584249853 + 22.996869816237496i), (0 + 0i),
	(15.562305898749054 - 8.057480106940814i), (0 + 0i),
	(-33.88854381999832 - 10.857649092690291i), (0 + 0i),
	(-2.854101966249685 + 1.1755705045849467i), (0 + 0i),
	(-4.618033988749894 - 8.057480106940814i), (0 + 0i),
	(-4.23606797749979 - 9.23305061152576i), (0 + 0i), (0 + 0i),
	(-4.259818534174122 - 3.2063955066654932i), (0 + 0i),
	(1.1191301111010779 - 6.167853480924767i), (0 + 0i),
	(6.4116384820847365 - 1.3878879254096894i), (0 + 0i),
	(11.341559150781181 - 6.3742489875898665i), (0 + 0i),
	(12054.234470881485 - 3918.7611270475163i), (0 + 0i),
	(12665.487880901226 - 52.576361779246916i), (0 + 0i),
	(2.1381810100900647 + 9.47870044741421i), (0 + 0i),
	(-0.9454244412447408 + 13.577627128281016i), (0 + 0i),
	(8.07111904476048 + 1.1381810100901792i), (0 + 0i),
	(2.236067977500512 + 6.8819096023556785i), (-2 + 0i), (0 + 0i),
	(0.8541019662496847 - 3.5267115137548384i), (0 + 0i),
	(0.4376941012509459 + 8.057480106940814i), (0 + 0i),
	(-5.854101966249685 - 5.706339097770921i), (0 + 0i),
	(20.562305898749052 - 0.27751455142577464i), (0 + 0i), (51370 + 0i), (0 + 0i),
	(20.562305898749052 + 0.27751455142577464i), (0 + 0i),
	(-5.854101966249685 + 5.706339097770921i), (0 + 0i),
	(0.4376941012509459 - 8.057480106940814i), (0 + 0i),
	(0.8541019662496847 + 3.5267115137548384i), (0 + 0i), (0 + 0i),
	(2.236067977500512 - 6.8819096023556785i), (0 + 0i),
	(8.07111904476048 - 1.1381810100901792i), (0 + 0i),
	(-0.9454244412447408 - 13.577627128281016i), (0 + 0i),
	(2.1381810100900647 - 9.47870044741421i), (0 + 0i),
	(12665.487880901226 + 52.576361779246916i), (0 + 0i),
	(12054.234470881485 + 3918.7611270475163i), (0 + 0i),
	(11.341559150781181 + 6.3742489875898665i), (0 + 0i),
	(6.4116384820847365 + 1.3878879254096894i), (0 + 0i),
	(1.1191301111010779 + 6.167853480924767i), (0 + 0i),
	(-4.259818534174122 + 3.2063955066654932i),
	(2.618033988749895 - 4.2532540417602i), (0 + 0i),
	(-4.23606797749979 + 9.23305061152576i), (0 + 0i),
	(-4.618033988749894 + 8.057480106940814i), (0 + 0i),
	(-2.854101966249685 - 1.1755705045849467i), (0 + 0i),
	(-33.88854381999832 + 10.857649092690291i), (0 + 0i),
	(15.562305898749054 + 8.057480106940814i), (0 + 0i),
	(-31.65247584249853 - 22.996869816237496i), (0 + 0i),
	(-10.618033988749895 + 1.9021130325903077i), (0 + 0i),
	(2.0901699437494745 - 1.1755705045849454i), (0 + 0i),
	(-4.76393202250021 - 8.5065080835204i), (0 + 0i), (0 + 0i),
	(-3.0604974729149275 - 5.736011568605747i), (0 + 0i),
	(-2.2360679774996584 + 1.6245984811645746i), (0 + 0i),
	(-1.1381810100900969 - 2.5182821866117537i), (0 + 0i),
	(0.2053374728119497 - 8.11467589646806i), (0 + 0i),
	(10.537333085600949 - 4.060497472915017i), (0 + 0i),
	(9.567005556436925 + 8.816712471755087i), (0 + 0i),
	(7.031976668605138 + 6.276082318435137i), (0 + 0i),
	(-1.2342031427713414 + 2.280021964409276i), (0 + 0i),
	(8.892531174201782 - 8.520147021340158i), (0 + 0i),
	(4.516089941908957 + 3.2965654504144895i),
	(-2.8541019662496847 + 0.2775145514257753i), (0 + 0i),
	(1.3819660112501047 + 1.9021130325903073i), (0 + 0i),
	(0.2360679774997898 - 2.1796275840160826i), (0 + 0i),
	(-7.23606797749979 - 11.412678195541844i), (0 + 0i),
	(-5.618033988749894 - 2.628655560595668i), (0 + 0i),
	(3.618033988749895 - 7.330937578935453i), (0 + 0i),
	(3.854101966249684 - 5.706339097770922i), (0 + 0i),
	(-2.2360679774997902 - 6.881909602355869i), (0 + 0i),
	(12.47213595499958 - 2.906170112021443i), (0 + 0i),
	(-3.6180339887498945 - 1.1755705045849458i), (0 + 0i), (0 + 0i),
	(3.559401350563398 + 9.567005556434701i), (0 + 0i),
	(12.857006514435408 + 11.057480106941002i), (0 + 0i), (10 + 0i), (0 + 0i),
	(3.795469328063323 - 5.057480106940792i), (0 + 0i),
	(12.620938536936137 - 5.0948696014349935i), (0 + 0i),
	(-1.8974133749038629 + 2.7224854485746164i), (0 + 0i),
	(2.3386546025957067 + 1.1191301111012617i), (0 + 0i), (-2 + 8i), (0 + 0i),
	(-8.518994490094439 - 5.5912660661006175i), (0 + 0i),
	(-12.755062467594591 + 3.277514551425334i),
	(0.3819660112501051 - 2.628655560595668i), (0 + 0i),
	(-8.381966011250105 - 1.1755705045849463i), (0 + 0i),
	(1.8885438199983178 + 9.06153718637195i), (0 + 0i),
	(0.23606797749978892 + 2.179627584016083i), (0 + 0i),
	(-9.090169943749473 - 1.9021130325903068i), (0 + 0i),
	(-4.562305898749054 + 0.2775145514257753i), (0 + 0i),
	(-2.381966011250103 + 0.27751455142577486i), (0 + 0i),
	(-9.23606797749979 - 5.257311121191336i), (0 + 0i),
	(-0.34752415750147203 + 1.069569378312981i), (0 + 0i),
	(3.8541019662496847 - 1.9021130325903068i), (0 + 0i), (0 + 0i),
	(-1.7734010631007484 - 6.411638482085072i), (0 + 0i),
	(-4.458053684715686 - 11.232848261033226i), (0 + 0i),
	(2.6660450550905175 + 12.698622074110702i), (0 + 0i),
	(-2.2360679774997854 - 1.6245984811645338i), (0 + 0i),
	(-5.411638482084527 + 8.027807636106559i), (0 + 0i),
	(2.719978035591339 + 5.647706459585381i), (0 + 0i),
	(-10.128599151701406 - 4.7159209561596i), (0 + 0i),
	(10.178475052770501 + 0.4839100580909341i), (0 + 0i),
	(5.0008919469614685 - 3.480534028619176i), (0 + 0i),
	(-5.094869601436027 + 7.363627415743853i),
	(3.8541019662496847 + 8.057480106940814i), (0 + 0i),
	(-2.7639320225002098 - 7.053423027509677i), (0 + 0i),
	(-2.854101966249685 - 3.5267115137548384i), (0 + 0i),
	(-1.3819660112501047 + 1.9021130325903075i), (0 + 0i),
	(-4.23606797749979 - 9.23305061152576i), (0 + 0i),
	(1.381966011250105 + 3.3551980886010284i), (0 + 0i),
	(3.5278640450004204 - 12.310734148701014i), (0 + 0i),
	(3.6180339887498945 + 1.1755705045849465i), (0 + 0i),
	(-3.3819660112501047 - 4.2532540417602i), (0 + 0i),
	(2.2360679774997894 - 1.6245984811645324i), (0 + 0i), (0 + 0i),
	(8.764835310677139 - 1.9238859367485226i), (0 + 0i),
	(-1.6660450550905201 - 6.229503485085139i), (0 + 0i),
	(-7.998847468754418 + 6.341559150781226i), (0 + 0i),
	(5.1649489327391525 + 2.666045055090495i), (0 + 0i),
	(2.2360679775010794 + 6.881909602356245i), (0 + 0i),
	(7.495886511675053 + 5.557536515835409i), (0 + 0i),
	(-5.591266066100834 + 0.012486406574207187i), (0 + 0i),
	(4.060497472914843 + 10.79245196208926i), (0 + 0i),
	(-8.577627128280994 + 2.570022922409268i), (0 + 0i),
	(5.73266050294879 - 3.9655787577012136i),
}

var cosxcosyTinySpect = []uint8{
	45, 0, 47, 0, 30, 0, 47, 0, 42, 0, 25, 0, 42, 0, 47, 0, 30, 0, 47, 0,
	0, 48, 0, 54, 0, 59, 0, 44, 0, 54, 0, 49, 0, 45, 0, 56, 0, 47, 0, 54,
	53, 0, 31, 0, 43, 0, 36, 0, 61, 0, 36, 0, 56, 0, 28, 0, 40, 0, 50, 0,
	0, 54, 0, 46, 0, 56, 0, 58, 0, 46, 0, 55, 0, 31, 0, 62, 0, 60, 0, 47,
	30, 0, 39, 0, 17, 0, 57, 0, 28, 0, 40, 0, 54, 0, 27, 0, 54, 0, 52, 0,
	0, 62, 0, 56, 0, 52, 0, 30, 0, 34, 0, 63, 0, 46, 0, 56, 0, 67, 0, 56,
	31, 0, 36, 0, 61, 0, 49, 0, 48, 0, 52, 0, 46, 0, 62, 0, 27, 0, 28, 0,
	0, 44, 0, 60, 0, 30, 0, 55, 0, 62, 0, 58, 0, 51, 0, 31, 0, 31, 0, 47,
	42, 0, 55, 0, 28, 0, 57, 0, 86, 0, 68, 0, 84, 0, 33, 0, 54, 0, 56, 0,
	0, 43, 0, 46, 0, 47, 0, 62, 0, 222, 0, 222, 0, 55, 0, 63, 0, 52, 0, 49,
	25, 0, 36, 0, 51, 0, 52, 0, 72, 0, 254, 0, 72, 0, 52, 0, 51, 0, 36, 0,
	0, 49, 0, 52, 0, 63, 0, 55, 0, 222, 0, 222, 0, 62, 0, 47, 0, 46, 0, 43,
	42, 0, 56, 0, 54, 0, 33, 0, 84, 0, 68, 0, 86, 0, 57, 0, 28, 0, 55, 0,
	0, 47, 0, 31, 0, 31, 0, 51, 0, 58, 0, 62, 0, 55, 0, 30, 0, 60, 0, 44,
	31, 0, 28, 0, 27, 0, 62, 0, 46, 0, 52, 0, 48, 0, 49, 0, 61, 0, 36, 0,
	0, 56, 0, 67, 0, 56, 0, 46, 0, 63, 0, 34, 0, 30, 0, 52, 0, 56, 0, 62,
	30, 0, 52, 0, 54, 0, 27, 0, 54, 0, 40, 0, 28, 0, 57, 0, 17, 0, 39, 0,
	0, 47, 0, 60, 0, 62, 0, 31, 0, 55, 0, 46, 0, 58, 0, 56, 0, 46, 0, 54,
	53, 0, 50, 0, 40, 0, 28, 0, 56, 0, 36, 0, 61, 0, 36, 0, 43, 0, 31, 0,
	0, 54, 0, 47, 0, 56, 0, 45, 0, 49, 0, 54, 0, 44, 0, 59, 0, 54, 0, 48,
}

func TestSfft(t *testing.T) {
	fft := FFT(SgrayCosxCosyTiny)
	// Expected results were generated with go-fftw, which give very slightly
	// different results, so now we do an approximate comparison, which is
	// simpler and more robust than replacing the expected values.
	tol := 1e-10
	for i, v := range fft.Pix {
		if !sfft.CmplxEqualApprox(v, cosxcosyTinyFft[i], tol) {
			t.Errorf("Error: wrong fft. Expected:\n%v\nGot:\n%v\n",
				cosxcosyTinyFft, fft.Pix)
		}
	}
	spect := LogSpectrum(fft).Pix()
	if !reflect.DeepEqual(spect, cosxcosyTinySpect) {
		t.Errorf("Error: wrong fft spectrum image. Expected:\n%v\nGot:\n%v\n",
			cosxcosyTinySpect, spect)
	}
}
